{% extends 'app/base.html' %}

{% block title %}Calendar | Remindit{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Calendar Header -->
    <div class="calendar-header">
        <div class="calendar-title">
            <h2 id="currentMonthYear">April 2025</h2>
        </div>
        
        <div class="calendar-actions">
            <div class="calendar-nav">
                <button id="prevMonth" class="btn-nav"><i class="bi bi-chevron-left"></i></button>
                <button id="today" class="btn-nav btn-today">Today</button>
                <button id="nextMonth" class="btn-nav"><i class="bi bi-chevron-right"></i></button>
            </div>
            
            <div class="view-options">
                <button class="btn-view active" data-view="month">Month</button>
                <button class="btn-view" data-view="week">Week</button>
                <button class="btn-view" data-view="day">Day</button>
            </div>
        </div>
    </div>
    
    <!-- Calendar Grid -->
    <div class="calendar-container">
        <div class="calendar-grid">
            <div class="weekdays">
                <div>Sun</div>
                <div>Mon</div>
                <div>Tue</div>
                <div>Wed</div>
                <div>Thu</div>
                <div>Fri</div>
                <div>Sat</div>
            </div>
            
            <div class="days-grid" id="calendarDays">
                <!-- Calendar days will be generated by JavaScript -->
            </div>
        </div>
    </div>
    
    <!-- Upcoming Events Section -->
    <div class="upcoming-events">
        <div class="section-header">
            <h3>Upcoming Events</h3>
            <a href="{% url 'tasks' %}" class="view-all">View All <i class="bi bi-arrow-right"></i></a>
        </div>
        
        <div class="events-list" id="upcomingEventsList">
            {% if upcoming_events %}
                {% for event in upcoming_events %}
                <div class="event-card {{ event.event_type }}" data-event-id="{{ event.id }}">
                    <div class="event-card-header">
                        <span class="event-type {{ event.event_type }}">{{ event.get_event_type_display }}</span>
                        <div class="event-actions">
                            <button class="event-action-btn edit-btn"><i class="bi bi-pencil"></i></button>
                        </div>
                    </div>
                    <h3 class="event-title">{{ event.title }}</h3>
                    <p class="event-description">{{ event.description|default:"No description" }}</p>
                    <div class="event-meta">
                        <div class="event-meta-item">
                            <i class="bi bi-calendar3"></i>
                            <span>{{ event.date|date:"D, M d" }}</span>
                        </div>
                        {% if event.time %}
                        <div class="event-meta-item">
                            <i class="bi bi-clock"></i>
                            <span>{{ event.time|time:"g:i A" }}</span>
                        </div>
                        {% endif %}
                        {% if event.priority %}
                        <div class="event-meta-item">
                            <span class="priority-badge {{ event.priority }}">{{ event.get_priority_display }}</span>
                        </div>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            {% else %}
                <div class="text-center p-4">No upcoming events</div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Set CSRF token for AJAX requests
    const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;
    
    // Add CSRF token to all AJAX requests
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    
    // Set up AJAX with CSRF token
    document.addEventListener('DOMContentLoaded', function() {
        // Add CSRF token to AJAX requests
        const csrftoken = getCookie('csrftoken');
        
        // Add event listeners for AJAX requests
        document.addEventListener('click', function(e) {
            // Handle event card clicks
            if (e.target.closest('.event-card')) {
                const eventCard = e.target.closest('.event-card');
                const eventId = eventCard.getAttribute('data-event-id');
                
                // Don't trigger if clicking on action buttons
                if (!e.target.closest('.event-actions')) {
                    showEventDetails(eventId);
                }
            }
            
            // Handle edit button clicks
            if (e.target.closest('.edit-btn')) {
                e.preventDefault();
                e.stopPropagation();
                
                const eventCard = e.target.closest('.event-card');
                const eventId = eventCard.getAttribute('data-event-id');
                
                fetch(`/api/events/${eventId}/update/`)
                    .then(response => response.json())
                    .then(event => {
                        showAddEventModal(event.event_type, null, event);
                    });
            }
        });
    });
</script>
{% endblock %}